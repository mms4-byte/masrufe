<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>النظام الملكي V10 - التختيم النهائي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --border: #30363d;
            --accent: #58a6ff; --text: #c9d1d9; --gold: #d29922;
            --danger: #ff7b72; --success: #7ee787;
        }

        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 30px; }

        /* شاشة القفل */
        #lock-screen { position: fixed; inset: 0; background: var(--bg); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #passInput { background: #090c10; border: 2px solid var(--border); color: var(--gold); padding: 15px; border-radius: 15px; text-align: center; font-size: 2.5rem; width: 160px; outline: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* التطبيق الرئيسي */
        #main-app { display: none; max-width: 600px; margin: auto; padding: 10px; }
        .stats-sticky { position: sticky; top: 10px; z-index: 100; background: rgba(13, 17, 23, 0.95); backdrop-filter: blur(10px); padding: 15px; border-radius: 15px; border: 1px solid var(--border); display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { text-align: center; }
        .stat-card small { display: block; color: #8b949e; font-size: 0.7rem; margin-bottom: 5px; }

        .input-box { background: var(--card); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-box input { background: #0d1117; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 8px; outline: none; }
        .btn-add { background: var(--accent); color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: 800; cursor: pointer; grid-column: span 2; }

        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 15px; overflow: hidden; }
        th { background: #21262d; padding: 12px; font-size: 0.8rem; }
        td { padding: 15px 10px; text-align: center; border-bottom: 1px solid var(--border); }

        /* الوصل الملكي - التصميم النهائي */
        #receipt-render {
            position: absolute; left: -9999px; 
            width: 360px; background: #fffbe6; color: #000 !important; 
            padding: 40px 25px; border: 2px solid #000; box-sizing: border-box; text-align: center;
        }
        .rec-header h2 { font-size: 26px; margin: 10px 0; font-weight: 900; color: #000; }
        .rec-table-final { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .rec-table-final th { border-bottom: 2px solid #000; padding: 8px; text-align: right; color: #000 !important; background: transparent; }
        .rec-table-final td { padding: 10px 8px; border-bottom: 1px dashed #777; text-align: right; font-weight: bold; color: #000 !important; background: transparent; }
        .total-box { background: #000; color: #fff; font-size: 22px; font-weight: bold; padding: 12px; border-radius: 5px; margin-top: 15px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; }
        .modal-content { background: var(--card); max-width: 450px; margin: 40px auto; border-radius: 20px; border: 1px solid var(--border); padding: 20px; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <i class="fas fa-crown" style="font-size: 40px; color: var(--gold); margin-bottom: 20px;"></i>
        <h2 style="color:var(--gold)">النظام الملكي V10</h2>
        <input type="password" id="passInput" maxlength="4" placeholder="••••" oninput="checkPass(this.value)">
    </div>

    <div id="main-app">
        <div class="stats-sticky">
            <div class="stat-card"><small>الراتب</small><b>720,000</b></div>
            <div class="stat-card"><small>المصروف</small><b id="totalSpent" style="color:var(--danger)">0</b></div>
            <div class="stat-card"><small>المتبقي</small><b id="totalBalance" style="color:var(--success)">0</b></div>
        </div>

        <button onclick="openLog()" style="background:var(--gold); color:#000; width:100%; border:none; padding:15px; border-radius:12px; font-weight:bold; margin-bottom:20px; cursor:pointer;">
            <i class="fas fa-file-invoice-dollar"></i> عرض السجل الملكي والطباعة
        </button>

        <div class="input-box">
            <input type="text" id="itemName" placeholder="المادة (م، خ...)">
            <input type="number" id="itemPrice" placeholder="المبلغ">
            <button class="btn-add" onclick="addItem()">إضافة للسجل</button>
        </div>

        <table>
            <thead><tr><th>التاريخ</th><th>المادة</th><th>المبلغ</th><th>حذف</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--gold);">ملخص المصروفات</h3>
            <div id="logItems"></div>
            <button onclick="generateReceipt()" style="background:var(--success); color:#000; width:100%; border:none; padding:15px; border-radius:10px; font-weight:bold; margin-top:20px;">استخراج الوصل النهائي</button>
            <button onclick="closeLog()" style="background:#333; color:#fff; width:100%; border:none; padding:10px; border-radius:10px; margin-top:10px;">رجوع</button>
        </div>
    </div>

    <div id="receipt-render">
        <i class="fas fa-crown" style="font-size: 30px;"></i>
        <div class="rec-header"><h2>النظام الملكي</h2><p>كشف المصروفات الشخصية</p></div>
        <div id="recDate" style="font-weight:bold; margin-bottom:10px; border-bottom:2px solid #000; padding-bottom:5px;"></div>
        <table class="rec-table-final">
            <thead><tr><th>المادة</th><th style="text-align:left">المبلغ</th></tr></thead>
            <tbody id="recItems"></tbody>
        </table>
        <div style="font-weight:bold; margin-top:20px;">إجمالي المبلغ</div>
        <div class="total-box" id="recTotal"></div>
        <p style="font-size:10px; margin-top:30px; border-top:1px solid #000; padding-top:10px;">* وثيقة إلكترونية صادرة من نظام V10 *</p>
    </div>

<script>
    const SALARY = 720000;
    const STORAGE_KEY = "ROYAL_V10_FINAL_STABLE";
    const shortcuts = {'م': 'مولد', 'خ': 'مخضر', 'د': 'دجاج/لحوم', 'ن': 'انترنت', 'ص': 'مصروف شخصي', 'ر': 'رصيد'};
    let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    function checkPass(v) { if(v === "2006") { document.getElementById('lock-screen').style.display='none'; document.getElementById('main-app').style.display='block'; renderUI(); } }

    function addItem() {
        let name = document.getElementById('itemName').value.trim();
        let price = parseFloat(document.getElementById('itemPrice').value);
        if(!name || isNaN(price)) return;
        if(shortcuts[name]) name = shortcuts[name];
        db.push({ id: Date.now(), name, price: price * 1000, date: new Date().toLocaleDateString('ar-EG', {month:'2-digit', day:'2-digit'}) });
        save();
        document.getElementById('itemName').value=''; document.getElementById('itemPrice').value=''; document.getElementById('itemName').focus();
    }

    function renderUI() {
        const body = document.getElementById('tableBody'); body.innerHTML = ''; let total = 0;
        db.slice().reverse().forEach(item => {
            total += item.price;
            body.innerHTML += `<tr><td>${item.date}</td><td style="font-weight:bold">${item.name}</td><td style="color:var(--gold); font-weight:bold">${item.price.toLocaleString()}</td><td><i class="fas fa-trash-alt" style="color:var(--danger); cursor:pointer" onclick="deleteItem(${item.id})"></i></td></tr>`;
        });
        document.getElementById('totalSpent').innerText = total.toLocaleString();
        document.getElementById('totalBalance').innerText = (SALARY - total).toLocaleString();
    }

    function deleteItem(id) { if(confirm("حذف؟")) { db = db.filter(i => i.id !== id); save(); } }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); renderUI(); }
    function openLog() {
        document.getElementById('logModal').style.display = 'block';
        const summary = db.reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.price; return acc; }, {});
        let html = ''; for(let k in summary) html += `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333;"><span>${k}</span><b>${summary[k].toLocaleString()}</b></div>`;
        document.getElementById('logItems').innerHTML = html || 'لا توجد بيانات';
    }
    function closeLog() { document.getElementById('logModal').style.display = 'none'; }

    function generateReceipt() {
        const summary = db.reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.price; return acc; }, {});
        document.getElementById('recDate').innerText = new Date().toLocaleString('ar-EG');
        let html = ''; let total = 0;
        for(let k in summary) {
            total += summary[k];
            html += `<tr><td style="color:#000 !important">${k}</td><td style="text-align:left; color:#000 !important">${summary[k].toLocaleString()}</td></tr>`;
        }
        document.getElementById('recItems').innerHTML = html;
        document.getElementById('recTotal').innerText = total.toLocaleString() + " د.ع";

        html2canvas(document.getElementById('receipt-render'), { scale: 3, backgroundColor: "#fffbe6" }).then(canvas => {
            const link = document.createElement('a');
            link.download = `وصل_الملكي_التختيم.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>
